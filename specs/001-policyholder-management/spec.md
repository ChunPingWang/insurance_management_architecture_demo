# Feature Specification: 保戶基本資料管理系統

**Feature Branch**: `001-policyholder-management`
**Created**: 2026-01-16
**Status**: Draft
**Input**: PRD.md - 保戶基本資料管理系統產品需求文件

## Clarifications

### Session 2026-01-16

- Q: 預期資料規模為何？ → A: 大型規模（保戶 > 100,000 筆，保單 > 500,000 筆）

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 新增保戶資料 (Priority: P1)

內勤人員需要在系統中建立新保戶的基本資料，包含身分證字號、姓名、性別、出生日期、聯絡方式及通訊地址，以便後續為該保戶建立保單。

**Why this priority**: 這是系統最核心的功能。沒有保戶資料，就無法進行任何保單管理。這是所有後續功能的基礎。

**Independent Test**: 可透過填寫保戶表單並提交來完整測試，成功後系統產生唯一保戶編號並顯示完整保戶資料。

**Acceptance Scenarios**:

1. **Given** 內勤人員已登入系統，**When** 填寫完整且有效的保戶資料並提交，**Then** 系統建立保戶並回傳保戶編號（格式：PH + 10位數字）
2. **Given** 內勤人員填寫保戶資料，**When** 身分證字號已存在於系統中，**Then** 系統顯示錯誤訊息「此身分證字號已存在」
3. **Given** 內勤人員填寫保戶資料，**When** 身分證字號格式不正確，**Then** 系統顯示格式驗證錯誤
4. **Given** 內勤人員填寫保戶資料，**When** 出生日期顯示未滿 18 歲，**Then** 系統顯示「保戶需年滿 18 歲」錯誤
5. **Given** 內勤人員填寫保戶資料，**When** 手機號碼不符合台灣格式（09xxxxxxxx），**Then** 系統顯示手機格式錯誤

---

### User Story 2 - 查詢保戶資料 (Priority: P1)

客服人員或外勤業務員需要快速查詢保戶的基本資料與其持有的保單狀態，以便提供客戶服務或業務諮詢。

**Why this priority**: 查詢是最高頻的操作，客服與業務人員需要即時取得保戶資訊來服務客戶，與新增功能同為核心功能。

**Independent Test**: 可透過輸入保戶編號或身分證字號查詢，驗證系統回傳正確的保戶資料。

**Acceptance Scenarios**:

1. **Given** 保戶已存在於系統中，**When** 使用保戶編號查詢，**Then** 系統顯示該保戶的完整基本資料
2. **Given** 保戶已存在於系統中，**When** 使用身分證字號查詢，**Then** 系統顯示該保戶的完整基本資料
3. **Given** 系統中有多位保戶，**When** 使用姓名進行模糊搜尋，**Then** 系統顯示所有姓名包含該關鍵字的保戶列表
4. **Given** 查詢條件無符合的保戶，**When** 執行查詢，**Then** 系統顯示「查無符合條件的保戶」
5. **Given** 系統中有大量保戶資料，**When** 查詢保戶列表，**Then** 系統回傳分頁結果並包含分頁資訊

---

### User Story 3 - 修改保戶資料 (Priority: P2)

內勤人員需要更新保戶的聯絡資訊（手機、Email、地址）或修正基本資料，以確保保戶資料的正確性與時效性。

**Why this priority**: 保戶資料會隨時間變動（搬家、換手機等），維護資料正確性是持續運營的必要功能，但相較於新增與查詢，使用頻率較低。

**Independent Test**: 可透過修改現有保戶的聯絡資訊並儲存來測試，驗證資料確實更新且更新時間戳記已變更。

**Acceptance Scenarios**:

1. **Given** 保戶存在且狀態為 ACTIVE，**When** 修改聯絡資訊並儲存，**Then** 系統更新資料並自動更新 updatedAt 時間戳記
2. **Given** 保戶存在，**When** 嘗試修改身分證字號，**Then** 系統拒絕修改並顯示「身分證字號不可修改」
3. **Given** 保戶狀態為 SUSPENDED，**When** 嘗試修改保戶資料，**Then** 系統拒絕修改並顯示「已停權保戶無法修改」
4. **Given** 保戶存在，**When** 修改手機號碼為無效格式，**Then** 系統顯示格式驗證錯誤

---

### User Story 4 - 刪除保戶資料 (Priority: P3)

內勤人員需要停用不再往來的保戶，系統採用軟刪除方式保留歷史資料供稽核使用。

**Why this priority**: 刪除操作較少發生，且採軟刪除設計，風險較低。

**Independent Test**: 可透過執行刪除操作後，驗證保戶狀態變更為 INACTIVE，且原資料仍可供稽核查詢。

**Acceptance Scenarios**:

1. **Given** 保戶存在於系統中，**When** 執行刪除操作，**Then** 保戶狀態變更為 INACTIVE（軟刪除）
2. **Given** 保戶已被軟刪除（狀態為 INACTIVE），**When** 查詢該保戶，**Then** 系統仍可回傳該保戶資料（含狀態資訊）

---

### User Story 5 - 新增保單 (Priority: P2)

內勤人員需要為現有保戶新增保單，記錄保單類型、保費、保額、生效日期等資訊。

**Why this priority**: 保單是保戶的核心資產，但需先有保戶才能新增保單，故優先順序次於保戶基本 CRUD。

**Independent Test**: 可透過選擇現有保戶並填寫保單資料來測試，驗證保單成功建立並關聯至該保戶。

**Acceptance Scenarios**:

1. **Given** 保戶存在且狀態為 ACTIVE，**When** 填寫完整保單資料並提交，**Then** 系統建立保單並關聯至該保戶
2. **Given** 保戶狀態為 INACTIVE 或 SUSPENDED，**When** 嘗試新增保單，**Then** 系統拒絕並顯示「僅可為 ACTIVE 狀態的保戶新增保單」
3. **Given** 填寫保單資料時，**When** 保單號碼與現有保單重複，**Then** 系統顯示「保單號碼已存在」
4. **Given** 填寫保單資料時，**When** 生效日期早於今日，**Then** 系統顯示「生效日期不可早於今日」

---

### User Story 6 - 查詢保戶保單 (Priority: P2)

客服人員或外勤業務員需要查詢特定保戶持有的所有保單，並可依類型或狀態篩選。

**Why this priority**: 保單查詢是客服與業務的日常操作，與保戶查詢密切相關。

**Independent Test**: 可透過輸入保戶編號查詢其保單列表，並測試類型與狀態篩選功能。

**Acceptance Scenarios**:

1. **Given** 保戶持有多張保單，**When** 查詢該保戶的保單，**Then** 系統顯示所有保單列表
2. **Given** 保戶持有不同類型保單，**When** 依保單類型（LIFE/ACCIDENT/SAFETY）篩選，**Then** 系統僅顯示符合類型的保單
3. **Given** 保戶持有不同狀態保單，**When** 依保單狀態（ACTIVE/LAPSED/TERMINATED）篩選，**Then** 系統僅顯示符合狀態的保單
4. **Given** 保戶無任何保單，**When** 查詢保單，**Then** 系統顯示「該保戶目前無保單」

---

### Edge Cases

- 當保戶同時被多位內勤人員編輯時，系統如何處理並發衝突？（採用樂觀鎖機制，後儲存者需重新載入資料）
- 當身分證字號輸入包含空白或特殊字元時，系統應先進行正規化處理後再驗證
- 當保戶有有效保單（ACTIVE）時，是否允許將保戶狀態改為 INACTIVE？（不允許，需先處理有效保單）
- 當保單到期日已過但狀態仍為 ACTIVE 時，系統應如何處理？（系統應有批次作業自動更新狀態）
- 當手機號碼或 Email 與其他保戶重複時，系統是否允許？（允許，因同一人可能是多位保戶的緊急聯絡人）

## Requirements *(mandatory)*

### Functional Requirements

#### 保戶管理

- **FR-001**: 系統 MUST 允許建立新保戶，自動產生唯一保戶編號（格式：PH + 10位數字）
- **FR-002**: 系統 MUST 驗證身分證字號格式正確性，且在系統中唯一
- **FR-003**: 系統 MUST 驗證保戶出生日期，確保年滿 18 歲
- **FR-004**: 系統 MUST 驗證手機號碼符合台灣格式（09xxxxxxxx）
- **FR-005**: 系統 MUST 驗證 Email 格式正確性（選填欄位）
- **FR-006**: 系統 MUST 支援依保戶編號、身分證字號精確查詢
- **FR-007**: 系統 MUST 支援依姓名模糊搜尋
- **FR-008**: 系統 MUST 支援保戶列表分頁查詢，包含排序與狀態篩選
- **FR-009**: 系統 MUST 允許修改保戶聯絡資訊，但禁止修改身分證字號與保戶編號
- **FR-010**: 系統 MUST 阻止修改狀態為 SUSPENDED 的保戶資料
- **FR-011**: 系統 MUST 採用軟刪除機制，將保戶狀態改為 INACTIVE 而非實際刪除
- **FR-012**: 系統 MUST 在每次資料異動時自動更新 updatedAt 時間戳記

#### 保單管理

- **FR-013**: 系統 MUST 允許為 ACTIVE 狀態的保戶新增保單
- **FR-014**: 系統 MUST 驗證保單號碼在系統中唯一
- **FR-015**: 系統 MUST 驗證保單生效日期不早於今日
- **FR-016**: 系統 MUST 支援三種保單類型：人壽險(LIFE)、意外險(ACCIDENT)、平安險(SAFETY)
- **FR-017**: 系統 MUST 支援查詢保戶持有的所有保單，並可依類型與狀態篩選

#### 事件發布

- **FR-018**: 系統 MUST 在保戶新增成功時發布 PolicyHolderCreated 事件
- **FR-019**: 系統 MUST 在保戶修改成功時發布 PolicyHolderUpdated 事件
- **FR-020**: 系統 MUST 在保戶刪除成功時發布 PolicyHolderDeleted 事件
- **FR-021**: 系統 MUST 在保單新增成功時發布 PolicyAdded 事件

### Key Entities

- **保戶 (PolicyHolder)**: 與保險公司簽訂保險契約的自然人。包含身分識別（身分證字號）、個人資訊（姓名、性別、出生日期）、聯絡方式（手機、Email、地址）、狀態（ACTIVE/INACTIVE/SUSPENDED）

- **保單 (Policy)**: 保險契約的書面憑證。包含保單識別（保單編號、保單號碼）、保單類型（LIFE/ACCIDENT/SAFETY）、財務資訊（保費、保額）、有效期間（生效日、到期日）、狀態（ACTIVE/LAPSED/TERMINATED）。每張保單必須關聯至一位保戶。

- **地址 (Address)**: 保戶的通訊地址。包含郵遞區號、縣市、區域、街道地址。作為保戶的組成部分（值物件）。

- **領域事件 (Domain Event)**: 記錄系統中重要的業務事件。包含 PolicyHolderCreated、PolicyHolderUpdated、PolicyHolderDeleted、PolicyAdded、PolicyStatusChanged。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 內勤人員可在 2 分鐘內完成新保戶資料的建立
- **SC-002**: 客服人員可在 5 秒內透過身分證字號或保戶編號查詢到保戶資料
- **SC-003**: 保戶列表查詢（含分頁）回應時間對使用者感知為即時（無明顯等待）
- **SC-004**: 系統可支援 100 位使用者同時操作而不影響使用體驗
- **SC-005**: 所有保戶與保單的資料異動皆有完整的事件記錄可供稽核追蹤
- **SC-006**: 敏感資料（身分證字號）在儲存時受到保護，非授權人員無法直接讀取原始值
- **SC-007**: 系統可用性達 99.5%，確保業務連續性
- **SC-008**: 單元測試覆蓋率達 80% 以上，確保程式碼品質

## Assumptions

- 預期資料規模為大型：保戶 > 100,000 筆，保單 > 500,000 筆（需考量分頁查詢與索引設計）
- 本系統僅處理自然人保戶，不處理法人客戶
- 身分證字號驗證採用台灣標準格式（首位英文 + 9 位數字 + 檢查碼）
- 手機號碼僅支援台灣行動電話格式（09 開頭）
- 保單生效日期限制「不早於今日」是指系統處理當日
- 軟刪除的保戶資料保留期限依循公司資料保留政策（預設永久保留供稽核）
- 領域事件採用非同步發布機制，不影響主要交易流程的回應時間
- 系統使用者已通過身分驗證，本功能不包含登入認證機制的實作
